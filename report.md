# CHAOS: EXPLOITING STATION TIME SYNCHRONIZATION IN 802.11 NETWORKS

## 書面報告

### 研究動機和背景

#### 無線網路（Wi-Fi）的普及與安全需求

隨著 IEEE 802.11 無線網路（Wi-Fi）的廣泛使用，許多日常應用與基礎設施皆依賴其進行無線通訊。為確保網路中所有設備的同步，
802.11使用Timing Synchronization Function（TSF） 機制，透過 Beacon frame廣播時戳，協助所有裝置校準本地時鐘。
這項設計雖具有實用性，但並未加入安全驗證機制，也未限制時間精度，導致其存在潛在的資安風險。以往多數研究聚焦於 Wi-Fi 加密層與認證層的攻擊，對底層協議中的時間同步機制的安全性探討則相對稀少。

#### Beacon Frame: 用於宣告網路存在的封包

Beacon Frame 是WiFi 無線基地台（AP）定期發送的訊息，用來宣告網路存在，協助裝置發現並連接無線網路。
Beacon Frame包含了網路名稱（SSID）、支援的連線速度、時間同步資訊、加密與網路功能資訊，
並每隔約 100 毫秒廣播一次，所有裝置都可接收。在網路用量大的地區，幾乎不可能發現虛擬的Beacon Frame。

#### CHAOS的動機與重要性

CHAOS的動機主要著眼於隱密的單向訊息傳遞。現代裝置的連線都需要經過複雜的安全機制，才能確保連線建立成功，攻擊者很難繞過這些訊息保護機制
，他們需要一種新的方法，不用受到安全機制的監督和控制，來隱密的傳遞訊息而不被人所知。
再來，Wifi在現代是非常常見的系統，CHAOS利用了Wifi機制中用於表達自身存在的Beacon Frame，能被所有裝置發現的特性，可以在不指定的特定裝置的情況下傳遞訊息。
同時，CHAOS利用了Beacon Frame的時間同步函數未受保護的特性，透過人為的操控時間同步資訊來隱密的傳輸資訊，也同時利用了都市空間中有極大量的Beacon Frame的廣播特性，用於隱匿訊息的傳遞。

### 方法介紹和分析

#### Transmitter 訊息發送端

Transmitter是CHAOS的訊息發送端，他是一個或多個裝置模擬多個AP(Access Point)。由於每一個AP都會發送自身存在的Beacon Frame，Transmitter可以用發送多個Beacon Frame的方式來模擬多個AP。這使Transmitter在都市環境中很難被發現，因為都市環境的背景中有大量的AP存在，一般觀察者很難發現這些Beacon Frame到底是一般裝置的Beacon Frame，還是CHAOS的Transmitter所發送的Beacon Frame。

##### TXAP(Transmision AP) 與 CAP(Covert AP)

在Transmitter發送的Beacon Frame中，有兩種不同的AP類型，分別是TXAP和CAP。TXAP是用來傳遞訊息的AP，而CAP則是用來隱匿訊息的AP。TXAP會發送包含訊息的Beacon Frame，而CAP則會發送不包含訊息的Beacon Frame。這樣的設計使得Transmitter可以在不被察覺的情況下傳遞訊息。

#### Receiver 訊息接收端

Receiver是CHAOS的訊息接收端，他會利用預先定義好的集合 $A$ 來判定誰是TXAP，誰是CAP，並利用TXAP接收的先後順序和TXAP的時間同步函數來解碼並接收訊息。
Receiver會偽裝成一般的Station，以避免被發現是CHAOS的接收端。同樣的，Receiver也很難在都市環境中被發現，因為都市環境中也要大量的Station存在。

#### Timing Synchronization Function(TSF)

TSF是IEEE 802.11無線網路中用來同步所有裝置時鐘的機制。每個AP都會定期發送Beacon Frame，並在其中包含一個時間戳記（TSF），這個時間戳記用來協助所有裝置校準本地時鐘。
TSF允許微秒等級的誤差，這減少了排程或掉包導致的時間不同步問題造成的影響，然而這個機制沒有考慮安全風險，因此CHAOS利用了這個機制，將訊息偽裝成雜訊藏匿於TSF之內。

連續的兩個TSF的定義如下：
$$ ts_{i+1} = ts_i + 100 TU + \varepsilon $$
其中100$TU$為102.4毫秒，$\varepsilon$為微小的誤差，通常在微秒等級。CHAOS利用這個機制，將訊息藏匿於$\varepsilon$之中，並透過操控$\varepsilon$的值來傳遞訊息，稱為Dealy Level(dl)。
$$ dl = l \times DS + \varepsilon _i $$
其中，$l$為步數，也是用於傳遞訊息的重點，Receiver會根據$dl$的值來解碼訊息。$DS$是步數的長度單位，$\varepsilon _i$是微小的誤差。

#### 排列

除了透過解碼TSF之外，Receiver也可以透過辨認接收TXAP的先後順序來增加解碼空間。在加密訊息後，Transmitter會依訊息內容決定TXAP的排列順序，Receiver則會根據TXAP的排列順序來解碼訊息。這樣的設計使得解碼空間能大幅增加，能夠改善訊息需要長時間傳遞的問題。

#### Burst

Burst是CHAOS中訊息傳遞的基礎單位。每過一個Burst就代表有一組TXAP被傳送。由於訊息很長，且每一個Burst的只能傳遞$log_2( n! \times L^n)$個bits，因此CHAOS會需要將訊息分成多段，並用多個Burst來傳遞整段訊息。

Receiver因此會需要知道Burst是第幾個，否則解碼順序會亂掉。此外，Burst的傳送並不一定是穩定的，可能會有幾個TXAP掉包導致解碼不完全，因此我們需要一個機制來確定Burst的順序。例如我們可以透過辨認TSF內的數值，若超過200$TU$即視為掉包，直接拋棄這一個burst的解碼過程並馬上執行下一個burst的解碼運算。由於Transmitter並不知道掉包狀況，Transmitter必須一直重復執行Burst的發送，而Receiver端一旦遇到掉包，就必須等待，直到下一個cycle的對應burst再次被傳送。

#### 共享參數

在利用CHAOS傳送訊息之前，我們必須確保Transmitter和Receiver知道一些共同的參數，才能確保訊息傳遞正確。這包含
$m,n$ ：AP和TXAP的數量。(非TXAP的AP即為CAP）
$\beta,A$ : AP和TXAP的集合，可以透過MAC來定義。$A \subseteq \beta$
$L,DS,BD$：$l$的數量，步數的距離和Burst的介線。

## 心得

### 許廷豪
這次的課程學到了很多，尤其是這次的CHAOS的實作，讓我更加了解了802.11背後的原理，以及Beacon Frame等無線通訊的機制。可以發現在無線網路的歷史發展上有很多漏洞都被一一的解決，然而一山還有一山高，常常能看到看似完美的機制又被破解，就像這次的CHAOS連建立網路連線都不用就可以傳遞訊息。這攻守來往非常有趣，讓人欲罷不能。希望未來能夠發展出一套最完美的機制，能夠在安全和效能上都有成效，確保使用者能夠安心使用，也不必花太多時間在安全驗證上。

### 林子恩

這學期修了無線通訊安全理論與實務，覺得蠻有趣的。一開始其實對無線安全沒有太多概念，只知道 Wi-Fi 可能會被破解，但上了課之後才發現裡面有很多技術細節，像是加密演算法、認證機制、還有實際攻防的技巧。也透過論文研究與實作，讓我更清楚攻擊者是怎麼下手的，也提醒自己平常要更注意資安問題。總體來說是蠻實用的一門課，也激發我對資安領域更深的興趣。

## 程式實作

請看程式碼註解

## 問題回覆

1. 如果攻擊者持續使用 CHAOS 傳送資料，是否會造成 Beacon 頻率或數據的統計偏移？
理論上不會，TSF的修改可以再加入細部的雜訊使其更像真實的Beacon Frame。此外，也可以利用訊息的進一步加密來平衡統計偏移。

2. 有沒有實際的實驗測試結果，對於資料傳輸成功率與具體效率為何?
成功率除非遇到極為稀少的同步問題，否則很難不成功，因為Transmitter會一直傳送直到永遠，因此只要Receiver能夠成功接到所有訊息就不會失敗。

3. 是否有針對 CHAOS 技術的反制手段或識破方式？攻擊者是否能學習規則來繞過它？
CHAOS是建立在有大量Beacon Frame存在於背景的情況下，若Beacon Frame不多很容易就能識破。
第二個問題看不懂，是攻擊CHAOS嗎? 若要識破CHAOS，最直接的方法就是降低背景Beacon Frame的數量，或是利用統計數據來發現CHAOS的TXAP的TSF是錯誤，但由於每一次burst的TXAP都會變（即CAP可能是下一次的TXAP，反之亦然），這個方法需要長時間的觀察。

4. 有什麼辦法能提高CHAOS的傳輸效率嗎？
最直接的方法就是增加TXAP的數量。但這又會使TXAP容易被發現，因此需要取捨。

5. 報告中提到 TSF 沒有加密或驗證設計，那這個協議設計上為什麼一開始沒有考慮到安全性？是因為技術限制，還是因為當初不覺得有攻擊風險？
我覺得沒有必要為TSF加密，因為這太花時間了。只能說這是時間成本下的考量。

6. 長時間使用 CHAOS 傳輸，會不會在系統觀察到的 Beacon 頻率或統計數據上，產生偏移或異常
同第一個問題

7. beacon frame  在各field上有沒識別用的byte?它是如何驗證某區段資料就是環境噪音呢？
	1. Beacon Frame有用來識別用的MAC。
	2. 沒有驗證是否是噪音的必要，那些資訊對某方來說很有用，但對其他人來說就是噪音。因此CHAOS只要讓Receiver知道哪些訊息有用，哪些訊息是垃圾就好。

8. 你們透過微調 Beacon 的時間戳來藏資料，那如果環境干擾很強，會不會導致訊號接收不穩定、錯過資料呢？
有可能，所以理論上Transmitter會發送burst直到永遠，用無限長的時間來確保資訊正確。

9. 被攻擊的裝置會不會自動改連其他 AP 而逃過攻擊？
CHAOS不是拿來攻擊的

10.  現存的防禦方法有沒有已可有效偵測Beacon Frame的方式
Beacon Frame大家都看得到，現在的問題是能不能發現是CHAOS的Beacon Frame，解法可能是透過長時間的統計來驗證。

11.  如何讓CHAOS在不修改硬體或驅動的前提下於現有裝置運作？
CHAOS需要硬體裝置來發送beacon frame，除此之外不需要新的硬體或驅動。

12. CHAOS的效率有辦法進一步提升嗎？
同第四個問題

13. 這種技術在不同廠商設備和不同802.11標準版本間的兼容性如何？
同第11個問題

14. Beacon frame 是否有特定欄位或位元（byte）用來作為識別？
同第七個問題之一

15. 如果 CHAOS攻擊者在Beacon 頻繁出現的擁擠網路環境，是否會影響其傳輸準確率？
有可能，但因為Transmitter會一直發送Burst，所以只會影響傳輸時間，不會影響準確率。

16. CHAOS 系統如何利用合法的 Wi-Fi Beacon 封包實現秘密通訊？
看這個報告

17.  如果對攻擊者難以偵測，那對接受方會不會也有同樣的風險
接收方也有可能會被發現，但因為其不一定要傳達出Beacon Frame，因此更難被發現。

18. 請問CHAOS有沒有辦法提高效率
同第四個問題

19. CHAOS在跨裝置的情況下會影響到通訊表現嗎？
理論上來講不會，但若硬體資源不足導致掉包仍然會影響。

20. CHAOS 的攻擊是否適用於手機或IoT的其他裝置？
CHAOS不是用來攻擊的，是用來隱匿的傳遞訊息用的。

21.  TSF 編碼是靠 ε 微調，那如果不同裝置的 clock drift 超過預期，會不會導致 decoding 錯誤？
不會，Burst的index是靠TSF判定的，若clock drift超過，Receiver會直接無視。

22. TSF如果誤差過大會發生什麼事
同第21個問題

23. 為什麼選擇子集A的長度n會影響傳輸容量？要怎麼確定n的最佳取值？
	1.每一個Burst的能傳遞$log_2( n! \times L^n)$個bits，所以n是影響解碼空間最重要的參數。
	2.要在隱匿性和效率之間做取捨。

24. 如何保证不同消息的排列不重复
排列重復沒關系，只要解碼成功就好。

25. TSF 編碼透過 ε 微調來對齊時間軸，若裝置間的 clock drift 遠大於預期範圍，系統還能正常還原訊息嗎？
同第21個問題

26. 在實際環境中CHAO這類攻擊，網路監控系統需要偵測哪些異常來檢查出這類攻擊
理論上Transmitter和Receiver會共用一定數量的MAC，若長時間觀測MAC的分布可能可以檢測出來。

27. Transmitter 與 Receiver 須事先共享 AP 集合 β、子集 A 及秘密金鑰。請問這些資訊交換的渠道如何保密？若密鑰洩漏，攻擊者如何防止被篡改或重放？
不利用網路，物理上的資訊共享是我覺得最合理的選項。密鑰就算洩漏，如果不知道子集A也無濟於事，因此我認為不需要太過擔心。

28. 攻擊者在同一區域佈署多個 Attack AP，Receiver 如何區分並正確重組？
CHAOS不是拿來攻擊的

29. 那我們要怎麼在不破壞802.11 TSF提供的關鍵時序同步與電源管理功能的前提下，又能徹底堵住CHAOS隱蔽通道？
最直接的方法就是讓Transmitter和Receiver無法共享一開始所需的資訊。

30. 為什麼要亂序傳播beacom呢
因為排序會影響解碼

31.  share argument需要被 Transmitter 和 Receiver 共享，如果這些參數不一致會導致什麼問題？
CHAOS會直接失效，這也是為什麼攻擊share argument是攻擊CHAOS最有效的方法之一。

32. 常用的 Wi-Fi 安全機制像WPA2/3 是否能夠防禦 CHAOS 攻擊？
我猜不行，因為他們沒有對TSF做出安全上的保證

33.  Beacon 每 100ms 廣播一次，資訊量不會太小嗎
所以會用多個beacon來傳播，能傳遞的資訊是以指數級成長的。

34. 若要偵測CHAOS隱藏通道，是否存在可用於時序異常或封包統計異常的自動化分析工具或演算法
可能要自己寫一個，但我相信是抓得到的

35. 要亂序傳播beacom意義是甚麼
同第30個問題

36. 你們的方法是利用 TSF 延遲來傳遞資訊，那如果環境中有其他裝置也在發送 Beacon Frame，會不會讓資料傳輸變得不穩定或更容易被發現？
這個技術就是利用其他裝置會發送beacon frame來隱藏自身存在，進而傳送訊息的，所以理論上越多beacon frame越好。

37. 連續 Burst 期間 AP 不按標準 Beacon 間隔送 frame，對 STA 的掃描、Roaming、信號品質報告有沒有副作用？
有可能，但會用這個技術傳遞訊息的話，應該不是正常的網路使用者，也不會去擔心網路品質是否會被影響。

38. 頻繁變化的SSID是否會成為被檢測的指標?
SSID就是放TSF的地方，他本來就會變化，不變才會被發現。

39. 為何採用base64進行編碼與解碼
這只是一個例子，你也可以使用其他方法加解密

40. 如何實際操控 beacon 傳送時機，利用接收端對 TSF timer 更新的機制，準確地在多台 Wi-Fi 間傳資訊
只要Receiver能夠確認第一個burst的TSF Base，理論上就能完整的傳遞訊息。

41. 在實作 Beacon 傳遞隱密訊息時，訊息穩定性或接收率會受到什麼影響？
穩定性可能會受到TXAP的數量影響，因此TXAP不能太多。

42. 提到的小bug有辦法解決嗎
沒有，不然我早就解決了

43. 系統是否有嘗試模擬在干擾嚴重的實體環境（例如多人 AP 密集空間）下進行訊息還原？
沒有，因為我沒有可以發自定義beacon frame的硬體設備。

44.   如果封包片段被加入隨機延遲，對通訊效能會造成什麼影響？
不會，因為TSF早就和實際傳送時間脫勾了。所以加隨機延遲只會讓它更像背景beacon frame，不會影響什麼。

45. 在高雜訊環境或多個 AP 同時廣播時，Beacon 可能被丟失或誤取，會怎麼影響訊息完整性？
Receiver會再等一個cycle，然後再讀對應的beacon frame。

46. 將隱密訊息進行加密是否會增加Beacon Frame的大小或複雜度?
Beacon Frame大小應該是固定的。反正加密之後可以再壓縮，只要和receiver講好就好。

47. 想問如何知道有完整接收到beacon傳送的訊息?
Receiver會確認一個burst的所有TXAP都有接收到，如果讀到了下一個burst卻沒有讀到所有TXAP的訊息，這一個burst就會被拋棄，待下一個cycle再收集。

48. Beacon 是每 0.1 秒廣播一次，那如果環境中有很多干擾（像人多的場景），還能穩定嗎？
外界干擾的影響有限，因為讀取Beacon並不會花太多時間，掉包也不會怎樣。穩定度的最大關鍵還是TXAP有沒有被傳到。

## 程式實作

At Github :https://github.com/XDOwO/CHAOS_FINAL
